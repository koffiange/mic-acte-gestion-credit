<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:of="http://omnifaces.org/functions"
      xmlns:o="http://omnifaces.org/ui">
    <h:head>
        <title style="font-size: larger; font-weight: bold">Enregistrement d'un acte portant mouvemant de crédit</title>
        <ui:include src="/resources/common/css.xhtml"/>
    </h:head>

    <h:body styleClass="main-body">
        <p:importEnum type="ci.gouv.dgbf.agc.enumeration.NatureActe" var="natureActe" allSuffix="ALL_VALUES"/>
        <p:importEnum type="ci.gouv.dgbf.agc.enumeration.CategorieActe" var="categorieActe" allSuffix="ALL_VALUES"/>
        <p:importEnum type="ci.gouv.dgbf.agc.enumeration.NatureTransaction" var="natureTransaction" allSuffix="ALL_VALUES"/>
        <h:form id="createForm">
            <p:growl globalOnly="true" showDetail="true" showSummary="true" severity="info, warn, error" life="15000"/>
            <p:remoteCommand name="cumuleCallBack" action="#{amcCreateBacking.cumules}" update="createForm:cumuleFls createForm:destinationDT createForm:enregisterBTN"/>

            <div class="ui-g">
                <div class="ui-g-12">
                    <p:fieldset legend="Informations générales de l'acte">
                        <p:panelGrid styleClass="col-w100" columnClasses="borderless">
                            <p:row>
                                <p:column>
                                    <h:outputLabel for="reference" value="Référence de l'acte" styleClass="text-bold"/><br/>
                                    <p:inputText id="reference" value="#{amcCreateBacking.acte.reference}"  styleClass="form-control"
                                                 required="true" requiredMessage="#{messages.required_field_message}"/>
                                    <p:message for="reference" />
                                </p:column>
                                <p:column>
                                    <h:outputLabel for="natureActe" value="Nature d'acte" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="natureActe" value="#{amcCreateBacking.acte.natureActe}" styleClass="form-control">
                                        <f:selectItem itemLabel="Choissisez une nature d'acte" itemValue=""/>
                                        <f:selectItem itemLabel="#{natureActe.ARRETE.libelle}" itemValue="#{natureActe.ARRETE}"/>
                                        <f:selectItem itemLabel="#{natureActe.ARRETE_INTERMINISTERIEL.libelle}" itemValue="#{natureActe.ARRETE_INTERMINISTERIEL}"/>
                                        <f:selectItem itemLabel="#{natureActe.DECISION.libelle}" itemValue="#{natureActe.DECISION}"/>
                                        <f:selectItem itemLabel="#{natureActe.DECRET.libelle}" itemValue="#{natureActe.DECRET}"/>
                                    </p:selectOneMenu>
                                </p:column>
                                <p:column>
                                    <h:outputLabel for="categorieActe" value="Categorie d'acte" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="categorieActe" value="#{amcCreateBacking.acte.categorieActe}" styleClass="form-control" disabled="true">
                                        <f:selectItem itemLabel="#{categorieActe.ACTE_MOUVEMENT.libelle}" itemValue="#{categorieActe.ACTE_MOUVEMENT}"/>
                                    </p:selectOneMenu>
                                </p:column>
                            </p:row>
                            <p:row>
                                <p:column colspan="3">
                                    <h:outputLabel for="libelle" value="Libelle de l'acte" styleClass="text-bold"/><br/>
                                    <p:inputText id="libelle" value="#{amcCreateBacking.acte.libelle}" styleClass="form-control-block"/>
                                </p:column>
                            </p:row>
                            <p:row>
                                <p:column>
                                    <h:outputLabel for="natureTransaction" value="Nature de mouvement" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="natureTransaction" value="#{amcCreateBacking.acte.natureTransaction}" styleClass="form-control">
                                        <f:selectItems value="#{natureTransaction.ALL_VALUES}" var="nt" itemLabel="#{nt.libelle}" itemValue="#{nt}"/>
                                        <p:ajax event="change" listener="#{amcCreateBacking.onNatureTransactionSelected()}" update="@form:addSignataireBtn"/>
                                    </p:selectOneMenu>
                                </p:column>
                                <p:column>
                                    <h:outputLabel for="dateSignature" value="Date signature" styleClass="text-bold form-control"/><br/>
                                    <p:datePicker id="dateSignature" value="#{amcCreateBacking.date}"/>
                                </p:column>

                                <!--
                                <p:column>
                                    <h:outputLabel for="section" value="Section Budgetaire" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="section" value="#{amcCreateBacking.selectedSection}"
                                                     converter="omnifaces.SelectItemsConverter" filter="true" filterMatchMode="contains"  styleClass="form-control">
                                        <f:selectItem itemLabel="Choissisez une section budgétaire" itemValue=""/>
                                        <f:selectItems value="#{amcCreateBacking.sectionList}" var="section" itemLabel="#{section.code} - #{of:abbreviate(section.libelle, 60)} " itemValue="#{section}"/>
                                    </p:selectOneMenu>
                                </p:column>

                                <p:column>
                                    <h:outputLabel for="modeleVisa" value="Modele de Visa" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="modeleVisa" value="#{amcCreateBacking.acte.modeleVisa}" styleClass="form-control">
                                        <f:selectItem itemLabel="Choissisez une section budgétaire" itemValue=""/>
                                        <f:selectItems value="#{amcCreateBacking.modeleVisaList}" var="modeleVisa" itemLabel="#{modeleVisa.code} - #{of:abbreviate(modeleVisa.libelle, 60)} " itemValue="#{modeleVisa}"/>
                                    </p:selectOneMenu>
                                </p:column>
                                -->
                            </p:row>

                            <!--
                            <p:row>
                                <p:column colspan="3">
                                    <h:outputLabel value="Corps de l'acte (parties ou articles)" styleClass="text-bold"/><br/>
                                    <p:panel header="" toggleable="true" >
                                        <f:facet name="actions">
                                            <p:commandButton value="Saisir corpus" action="#{amcCreateBacking.openCorpusDialog()}" styleClass="steel-btn" icon="fa fa-pencil">
                                                <p:ajax event="dialogReturn" listener="#{amcCreateBacking.corpusHandleReturn}" update="createForm:corpus" />
                                            </p:commandButton>
                                        </f:facet>
                                        <h:outputText value="#{of:abbreviate(amcCreateBacking.acte.corpus, 400)}" id="corpus" escape="false" />
                                    </p:panel>
                                </p:column>
                            </p:row>
                            -->

                            <p:row id="signataire">
                                <p:column>
                                    <h:outputLabel for="signataireFonction" value="Signataire Fonction" styleClass="text-bold"/><br/>
                                    <p:inputText id="signataireFonction" value="#{amcCreateBacking.signataire.fonction}" styleClass="form-control"/>
                                </p:column>
                                <p:column>
                                    <h:outputLabel for="signataireNom" value="Nom signataire" styleClass="text-bold"/><br/>
                                    <p:inputText id="signataireNom" value="#{amcCreateBacking.signataire.nom}" styleClass="form-control"/>
                                </p:column>
                                <p:column>
                                    <p:spacer height="5"/>
                                    <p:commandButton id="addSignataireBtn" value="Ajouter" action="#{amcCreateBacking.addSignataire()}" disabled="#{amcCreateBacking.addSignataireLock}"
                                                     update="createForm:signataireList createForm:signataireFonction createForm:signataireNom @this"
                                                     styleClass="btn-block steel-btn" icon="fa fa-plus"/>
                                </p:column>
                            </p:row>

                            <p:row>
                                <p:column colspan="3">
                                    <p:dataTable id="signataireList" value="#{amcCreateBacking.signataireList}" var="signataire" type="ordered" rowIndexVar="index"
                                                 emptyMessage="#{messages.empty_dataTable_message}" styleClass="borderless">
                                        <f:facet name="header">
                                            Liste des signataires
                                        </f:facet>
                                        <p:column headerText="#" styleClass="col-w5">#{index + 1}</p:column>
                                        <p:column headerText="Fonction" >#{signataire.fonction}</p:column>
                                        <p:column headerText="Nom du signataire">#{signataire.nom}</p:column>
                                        <p:column headerText="" styleClass="col-w10">
                                            <p:commandButton action="#{amcCreateBacking.deleteSignataire(signataire)}"
                                                  value="Retirer" update="createForm:signataireList @form:addSignataireBtn" icon="fa fa-trash"
                                                  styleClass="btn-block"/> </p:column>
                                    </p:dataTable>
                                </p:column>
                            </p:row>
                        </p:panelGrid>
                    </p:fieldset>

                    <p:spacer height="30" width="5"/>

                    <p:fieldset legend="Opération d'origine">
                        <p:menubar>
                            <f:facet name="options">
                                <p:commandButton value="Rechercher une ligne" action="#{amcCreateBacking.openLigneDepenseDialog('ORIGINE')}" icon="fa fa-search" styleClass="steel-btn">
                                    <p:ajax event="dialogReturn" listener="#{amcCreateBacking.handleReturn}" update="createForm:origineDT createForm:equilibreDG createForm:enregisterBTN"/>
                                </p:commandButton>
                            </f:facet>
                        </p:menubar>

                        <p:spacer height="5"/>

                        <p:dataTable id="origineDT" var="operation" value="#{amcCreateBacking.operationBagOrigine.operationList}"
                                     rowIndexVar="index" emptyMessage="#{messages.empty_dataTable_message}">
                            <p:column headerText="#" style="width:16px;text-align:center">
                                <h:outputText value="#{index + 1}" />
                            </p:column>

                            <p:column headerText="Activité" styleClass="col-w20">
                                <h:outputText value="#{operation.activiteCode} - #{operation.activiteLibelle}" styleClass="text-smaller"/>
                            </p:column>

                            <p:column headerText="Nature Economique">
                                <h:outputText value="#{operation.natureEconomiqueCode} - #{operation.natureEconomiqueLibelle}" styleClass="text-smaller"/>
                            </p:column>

                            <!--
                            <p:column headerText="Src. Financement">
                                <h:outputText value="#{operation.sourceFinancement}" />
                            </p:column>
                            -->

                            <p:column headerText="Budget actuel" styleClass="col-w10">
                                <h:outputText value="AE : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.budgetActuelAE)}" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.budgetActuelCP)}" />
                            </p:column>

                            <p:column headerText="Crédits disponibles" styleClass="col-w10">
                                <h:outputText value="AE : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.montantDisponibleAE)}" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.montantDisponibleCP)}" />
                            </p:column>

                            <p:column headerText="Prélèvements" styleClass="col-w20">
                                <div class="ui-inputgroup">
                                    <span class="ui-inputgroup-addon">AE</span>
                                    <p:inputNumber value="#{operation.montantOperationAE}" minValue="0"
                                                   maxValue="#{amcCreateBacking.handleMaxValue(operation.montantDisponibleAE)}" symbol=" FCFA" thousandSeparator="."
                                                   decimalSeparator="," symbolPosition="s" decimalPlaces="0" onchange="cumuleCallBack()"/>
                                </div>
                                <div class="ui-inputgroup">
                                    <span class="ui-inputgroup-addon">CP</span>
                                    <p:inputNumber value="#{operation.montantOperationCP}" minValue="0"
                                                   maxValue="#{amcCreateBacking.handleMaxValue(operation.montantDisponibleCP)}" symbol=" FCFA" thousandSeparator="."
                                                   decimalSeparator="," symbolPosition="s" decimalPlaces="0" onchange="cumuleCallBack()"/>
                                </div>
                            </p:column>

                            <p:column headerText="" styleClass="col-w10">
                                <p:commandButton action="#{amcCreateBacking.deleteOperation('ORIGINE', operation)}" value="supprimer"
                                                 update="createForm:origineDT createForm:equilibreDG createForm:enregisterBTN" styleClass="btn-block" icon="fa fa-trash"/>
                            </p:column>
                        </p:dataTable>
                    </p:fieldset>

                    <p:spacer height="30" width="5"/>

                    <p:fieldset legend="Opération de destination">
                        <p:menubar>
                            <f:facet name="options">
                                <p:commandButton value="Rechercher une ligne" action="#{amcCreateBacking.openLigneDepenseDialog('DESTINATION')}" icon="fa fa-search" styleClass="steel-btn">
                                    <p:ajax event="dialogReturn" listener="#{amcCreateBacking.handleReturn}" update="createForm:destinationDT createForm:equilibreDG createForm:enregisterBTN"/>
                                </p:commandButton>
                            </f:facet>
                        </p:menubar>

                        <p:spacer height="5"/>

                        <p:dataTable id="destinationDT" var="operation" value="#{amcCreateBacking.operationBagDestination.operationList}"
                                     rowIndexVar="index" emptyMessage="#{messages.empty_dataTable_message}">
                            <p:column headerText="#" style="width:16px;text-align:center">
                                <h:outputText value="#{index + 1}" />
                            </p:column>

                            <p:column headerText="Activité" styleClass="col-w20">
                                <h:outputText value="#{operation.activiteCode} - #{operation.activiteLibelle}" styleClass="text-smaller"/>
                            </p:column>

                            <p:column headerText="Nature Economique">
                                <h:outputText value="#{operation.natureEconomiqueCode} - #{operation.natureEconomiqueLibelle}" styleClass="text-smaller"/>
                            </p:column>

                            <!--
                            <p:column headerText="Src. Financement">
                                <h:outputText value="#{operation.sourceFinancement}" />
                            </p:column>
                            -->

                            <p:column headerText="Budget actuel" styleClass="col-w10">
                                <h:outputText value="AE : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.budgetActuelAE)}" styleClass="text-align-right"/>
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.budgetActuelCP)}" styleClass="text-align-right"/>
                            </p:column>

                            <p:column headerText="Crédits disponibles" styleClass="col-w10">
                                <h:outputText value="AE : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.montantDisponibleAE)}" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayBigDecimalThousandSeparator(operation.montantDisponibleCP)}" />
                            </p:column>

                            <p:column headerText="Compléments" styleClass="col-w20">
                                <div class="ui-inputgroup">
                                    <span class="ui-inputgroup-addon">AE</span>
                                    <p:inputNumber value="#{operation.montantOperationAE}" minValue="0"
                                                   maxValue="#{amcCreateBacking.handleMaxValue(amcCreateBacking.cumulRetranchementAE)}" symbol=" FCFA" thousandSeparator="."
                                                   decimalSeparator="," symbolPosition="s" decimalPlaces="0" onchange="cumuleCallBack()"/>
                                </div>
                                <div class="ui-inputgroup">
                                    <span class="ui-inputgroup-addon">CP</span>
                                    <p:inputNumber value="#{operation.montantOperationCP}" minValue="0"
                                                   maxValue="#{amcCreateBacking.handleMaxValue(amcCreateBacking.cumulRetranchementCP)}" symbol=" FCFA" thousandSeparator="."
                                                   decimalSeparator="," symbolPosition="s" decimalPlaces="0" onchange="cumuleCallBack()"/>
                                </div>
                            </p:column>

                            <p:column headerText="" styleClass="col-w10">
                                <p:commandButton action="#{amcCreateBacking.deleteOperation('DESTINATION', operation)}" value="supprimer"
                                                 update="createForm:destinationDT createForm:equilibreDG createForm:enregisterBTN" styleClass="btn-block" icon="fa fa-trash"/>
                            </p:column>
                        </p:dataTable>
                    </p:fieldset>

                    <p:spacer height="30" width="5"/>

                    <p:fieldset id="cumuleFls" legend="Equilibre des Opérations">
                        <p:panelGrid columns="3" id="equilibreDG" layout="grid">
                            <p:outputLabel value=" "/>
                            <p:outputLabel value="AE"/>
                            <p:outputLabel value="CP"/>

                            <p:outputLabel value="Cummule des prélèvements" styleClass="text-bold"/>
                            <p:outputLabel value="#{amcCreateBacking.displayBigDecimalThousandSeparator(amcCreateBacking.cumulRetranchementAE)}"/>
                            <p:outputLabel value="#{amcCreateBacking.displayBigDecimalThousandSeparator(amcCreateBacking.cumulRetranchementCP)}"/>

                            <p:outputLabel value="Cummule des compléments" styleClass="text-bold"/>
                            <p:outputLabel value="#{amcCreateBacking.displayBigDecimalThousandSeparator(amcCreateBacking.cumulAjoutAE)}" />
                            <p:outputLabel value="#{amcCreateBacking.displayBigDecimalThousandSeparator(amcCreateBacking.cumulAjoutCP)}" />

                            <p:outputLabel value="Equilibre des opérations"
                                           styleClass="text-bold" />
                            <h:outputText value="#{amcCreateBacking.displayBigDecimalThousandSeparator(amcCreateBacking.cumulRetranchementAE.subtract(amcCreateBacking.cumulAjoutAE))} #{amcCreateBacking.equilibreAE()}"
                                           styleClass="text-bold #{amcCreateBacking.cumulRetranchementAE.subtract(amcCreateBacking.cumulAjoutAE) ne amcCreateBacking.zero ? 'text-danger' : 'text-success'}"/>
                            <h:outputText value="#{amcCreateBacking.displayBigDecimalThousandSeparator(amcCreateBacking.cumulRetranchementCP.subtract(amcCreateBacking.cumulAjoutCP))} #{amcCreateBacking.equilibreCP()}"
                                           styleClass="text-bold #{amcCreateBacking.cumulRetranchementCP.subtract(amcCreateBacking.cumulAjoutCP) ne amcCreateBacking.zero ? 'text-danger' : 'text-success'}"/>
                        </p:panelGrid>


                        <p:spacer height="20" width="10"/>

                        <h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
                            <p:inputSwitch value="#{amcCreateBacking.appliquerActe}" offLabel="NON" onLabel="OUI"/>
                            <p:outputLabel value="APPLIQUER L'ACTE APRES ENREGISTREMENT ?" styleClass="text-bold"/>
                        </h:panelGrid>
                    </p:fieldset>

                    <p:spacer height="20" width="10"/>

                    <p:outputPanel id="enregisterBTN">
                        <div class="ui-g">
                            <div class="#{amcCreateBacking.displayEnregisterButton() ? 'ui-g-8' : 'ui-g-6'}" style="margin: 0px auto !important;">
                                <p:commandButton action="#{amcCreateBacking.persist()}"
                                                 disabled="#{amcCreateBacking.displayEnregisterButton()}" icon="fa fa-save"
                                                 value="#{amcCreateBacking.displayEnregisterButton() ? messages.equilibre_non_atteint_btn_message : messages.enregistrer}" update="@form" style="width: 100%"/>
                            </div>
                            <div class="ui-g-1">
                                <p:commandButton action="#{amcCreateBacking.close()}"
                                                 icon="fa fa-ban" styleClass="black-btn"
                                                 value="#{messages.annuler}" style="width: 100%"/>
                            </div>
                        </div>
                    </p:outputPanel>
                </div>
            </div>

        </h:form>
    </h:body>
</html>
