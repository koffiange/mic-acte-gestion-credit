<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:of="http://omnifaces.org/functions"
      xmlns:o="http://omnifaces.org/ui">
    <h:head>
        <title style="font-size: larger; font-weight: bold">Création d'un acte de mouvement de crédit</title>
        <ui:include src="/resources/common/css.xhtml"/>
    </h:head>

    <h:body styleClass="main-body">
        <p:importEnum type="ci.gouv.dgbf.agc.enumeration.NatureActe" var="natureActe" allSuffix="ALL_VALUES"/>
        <p:importEnum type="ci.gouv.dgbf.agc.enumeration.CategorieActe" var="categorieActe" allSuffix="ALL_VALUES"/>
        <p:importEnum type="ci.gouv.dgbf.agc.enumeration.NatureTransaction" var="natureTransaction" allSuffix="ALL_VALUES"/>
        <h:form id="createForm">
            <p:growl globalOnly="true" showDetail="true" showSummary="true" severity="info, warn, error" life="15000"/>

            <div class="ui-g">
                <div class="ui-g-12">
                    <p:fieldset legend="Informations générales de l'acte">
                        <p:panelGrid styleClass="col-w100" columnClasses="borderless">
                            <p:row>
                                <p:column>
                                    <h:outputLabel for="reference" value="Référence de l'acte" styleClass="text-bold"/><br/>
                                    <p:inputText id="reference" value="#{amcCreateBacking.acte.reference}" styleClass="form-control"/>
                                </p:column>
                                <p:column>
                                    <h:outputLabel for="natureActe" value="Nature d'acte" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="natureActe" value="#{amcCreateBacking.acte.natureActe}" styleClass="form-control">
                                        <f:selectItem itemLabel="Choissisez une nature d'acte" itemValue="" />
                                        <f:selectItem itemLabel="#{natureActe.ORDONNANCE.libelle}" itemValue="#{natureActe.ORDONNANCE}"/>
                                        <f:selectItem itemLabel="#{natureActe.ARRETE.libelle}" itemValue="#{natureActe.ARRETE}"/>
                                        <f:selectItem itemLabel="#{natureActe.ARRETE_INTERMINISTERIEL.libelle}" itemValue="#{natureActe.ARRETE_INTERMINISTERIEL}"/>
                                        <f:selectItem itemLabel="#{natureActe.DECISION.libelle}" itemValue="#{natureActe.DECISION}"/>
                                    </p:selectOneMenu>
                                </p:column>
                                <p:column>
                                    <h:outputLabel for="categorieActe" value="Categorie d'acte" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="categorieActe" value="#{amcCreateBacking.acte.categorieActe}" styleClass="form-control" disabled="true">
                                        <f:selectItem itemLabel="#{categorieActe.ACTE_MOUVEMENT.libelle}" itemValue="#{categorieActe.ACTE_MOUVEMENT}"/>
                                    </p:selectOneMenu>
                                </p:column>
                            </p:row>
                            <p:row>
                                <p:column>
                                    <h:outputLabel for="natureTransaction" value="Nature de la Transaction" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="natureTransaction" value="#{amcCreateBacking.acte.natureTransaction}" styleClass="form-control">
                                        <f:selectItem itemLabel="Choissisez une nature de transaction" itemValue="" />
                                        <f:selectItems value="#{natureTransaction.ALL_VALUES}" var="nt" itemLabel="#{nt.libelle}" itemValue="#{nt}"/>
                                        <!--
                                        <f:selectItem itemLabel="#{natureTransaction.VIREMENT.libelle}" itemValue="#{natureTransaction.VIREMENT}"/>
                                        <f:selectItem itemLabel="#{natureTransaction.TRANSFERT.libelle}" itemValue="#{natureTransaction.TRANSFERT}"/>
                                        -->
                                    </p:selectOneMenu>
                                </p:column>

                                <p:column>
                                    <h:outputLabel for="section" value="Section Budgetaire" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="section" value="#{amcCreateBacking.selectedSection}"
                                                     converter="omnifaces.SelectItemsConverter" filter="true" filterMatchMode="contains"  styleClass="form-control">
                                        <f:selectItem itemLabel="Choissisez une section budgétaire" itemValue=""/>
                                        <f:selectItems value="#{amcCreateBacking.sectionList}" var="section" itemLabel="#{section.code} - #{of:abbreviate(section.libelle, 60)} " itemValue="#{section}"/>
                                    </p:selectOneMenu>
                                </p:column>

                                <p:column>
                                    <h:outputLabel for="modeleVisa" value="Modele de Visa" styleClass="text-bold"/><br/>
                                    <p:selectOneMenu id="modeleVisa" value="#{amcCreateBacking.acte.modeleVisa}" styleClass="form-control">
                                        <f:selectItem itemLabel="Choissisez une section budgétaire" itemValue=""/>
                                        <f:selectItems value="#{amcCreateBacking.modeleVisaList}" var="modeleVisa" itemLabel="#{modeleVisa.code} - #{of:abbreviate(modeleVisa.libelle, 60)} " itemValue="#{modeleVisa}"/>
                                    </p:selectOneMenu>
                                </p:column>
                            </p:row>

                            <p:row>
                                <p:column colspan="3">
                                    <h:outputLabel value="Corps de l'acte (parties ou articles)" styleClass="text-bold"/><br/>
                                    <p:panel header="" toggleable="true" >
                                        <f:facet name="actions">
                                            <p:commandButton value="Saisir corpus" action="#{amcCreateBacking.openCorpusDialog()}" styleClass="steel-btn" icon="fa fa-pencil">
                                                <p:ajax event="dialogReturn" listener="#{amcCreateBacking.corpusHandleReturn}" update="createForm:corpus" />
                                            </p:commandButton>
                                        </f:facet>
                                        <h:outputText value="#{of:abbreviate(amcCreateBacking.acte.corpus, 400)}" id="corpus" escape="false" />
                                    </p:panel>
                                </p:column>
                            </p:row>

                            <p:row id="signataire">
                                <p:column>
                                    <h:outputLabel for="signataireFonction" value="Signataire Fonction" styleClass="text-bold"/><br/>
                                    <p:inputText id="signataireFonction" value="#{amcCreateBacking.signataire.fonction}" styleClass="form-control"/>
                                </p:column>
                                <p:column>
                                    <h:outputLabel for="signataireNom" value="Nom signataire" styleClass="text-bold"/><br/>
                                    <p:inputText id="signataireNom" value="#{amcCreateBacking.signataire.nom}" styleClass="form-control"/>
                                </p:column>
                                <p:column>
                                    <p:spacer height="5"/>
                                    <p:commandButton value="Ajouter" action="#{amcCreateBacking.addSignataire}" update="createForm:signataireList  createForm:signataireFonction  createForm:signataireNom"
                                                     styleClass="btn-block steel-btn" icon="fa fa-plus"/>
                                </p:column>
                            </p:row>

                            <p:row>
                                <p:column colspan="3">
                                    <p:dataTable id="signataireList" value="#{amcCreateBacking.signataireList}" var="signataire" type="ordered" rowIndexVar="index"
                                                 emptyMessage="#{messages.empty_dataTable_message}" styleClass="borderless">
                                        <f:facet name="header">
                                            Liste des signataires
                                        </f:facet>
                                        <p:column headerText="#" styleClass="col-w5">#{index + 1}</p:column>
                                        <p:column headerText="Fonction" >#{signataire.fonction}</p:column>
                                        <p:column headerText="Nom du signataire">#{signataire.nom}</p:column>
                                        <p:column headerText="" styleClass="col-w10"><p:commandButton action="#{amcCreateBacking.deleteSignataire(signataire)}"
                                                  value="Retirer" update="createForm:signataireList" icon="fa fa-trash" styleClass="btn-block"/> </p:column>
                                    </p:dataTable>
                                </p:column>
                            </p:row>

                            <p:row>
                                <p:column>
                                    <h:outputLabel for="dateSignature" value="Date signature" styleClass="text-bold"/><br/>
                                    <p:datePicker id="dateSignature" value="#{amcCreateBacking.date}"/>
                                </p:column>
                            </p:row>


                        </p:panelGrid>
                    </p:fieldset>

                    <p:fieldset legend="Opération d'origine">
                        <p:menubar>
                            <f:facet name="options">
                                <p:commandButton value="Rechercher une source de financement" action="#{amcCreateBacking.openLigneDepenseDialog('origine')}" icon="fa fa-search" styleClass="steel-btn">
                                    <p:ajax event="dialogReturn" listener="#{amcCreateBacking.handleReturn}" update="createForm:origineDT createForm:equilibreDG createForm:enregisterBTN"/>
                                </p:commandButton>
                            </f:facet>
                        </p:menubar>

                        <p:spacer height="5"/>

                        <p:dataTable id="origineDT" var="operation" value="#{amcCreateBacking.operationOrigineList}" rowIndexVar="index">
                            <p:column headerText="#" styleClass="col-w5">
                                <h:outputText value="#{index + 1}" />
                            </p:column>

                            <p:column headerText="Activité" styleClass="col-w20">
                                <h:outputText value="#{operation.activiteCode} - #{operation.activiteLibelle}" />
                            </p:column>

                            <p:column headerText="Nature Eco.">
                                <h:outputText value="#{operation.natureEconomiqueCode}" />
                            </p:column>

                            <p:column headerText="Src. Financement">
                                <h:outputText value="#{operation.sourceFinancement}" />
                            </p:column>

                            <p:column headerText="Budget actuel">
                                <h:outputText value="AE : #{amcCreateBacking.displayThousandSeparator(operation.budgetActuelAE)}" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayThousandSeparator(operation.budgetActuelCP)}" />
                            </p:column>

                            <p:column headerText="Crédits disponibles">
                                <h:outputText value="AE : -" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : -" />
                            </p:column>

                            <p:column headerText="Retranchements">
                                <h:outputText value="AE : #{amcCreateBacking.displayThousandSeparator(operation.montantOperationAE)}" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayThousandSeparator(operation.montantOperationCP)}" />
                            </p:column>

                            <p:column headerText="">
                                <p:commandButton action="#{amcCreateBacking.deleteOperation('origine', operation)}" value="supprimer"
                                                 update="createForm:origineDT" styleClass="btn-block" icon="fa fa-trash"/>
                            </p:column>
                        </p:dataTable>
                    </p:fieldset>

                    <p:fieldset legend="Opération de destination">
                        <p:menubar>
                            <f:facet name="options">
                                <p:commandButton value="Rechercher une source de financement" action="#{amcCreateBacking.openLigneDepenseDialog('destination')}" icon="fa fa-search" styleClass="steel-btn">
                                    <p:ajax event="dialogReturn" listener="#{amcCreateBacking.handleReturn}" update="createForm:cibleDT createForm:equilibreDG createForm:enregisterBTN"/>
                                </p:commandButton>
                            </f:facet>
                        </p:menubar>

                        <p:spacer height="5"/>

                        <p:dataTable id="cibleDT" var="operation" value="#{amcCreateBacking.operationDestinationList}" rowIndexVar="index">

                            <p:column headerText="#" styleClass="col-w5">
                                <h:outputText value="#{index + 1}" />
                            </p:column>

                            <p:column headerText="Activité" styleClass="col-w20">
                                <h:outputText value="#{operation.activiteCode} - #{operation.activiteLibelle}" />
                            </p:column>

                            <p:column headerText="Nature Eco.">
                                <h:outputText value="#{operation.natureEconomiqueCode}" />
                            </p:column>

                            <p:column headerText="Src. Financement">
                                <h:outputText value="#{operation.sourceFinancement}" />
                            </p:column>

                            <p:column headerText="Budget actuel">
                                <h:outputText value="AE : #{amcCreateBacking.displayThousandSeparator(operation.budgetActuelAE)}" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayThousandSeparator(operation.budgetActuelCP)}" />
                            </p:column>

                            <p:column headerText="Crédits disponibles">
                                <h:outputText value="AE : -" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : -" />
                            </p:column>

                            <p:column headerText="Ajouts">
                                <h:outputText value="AE : #{amcCreateBacking.displayThousandSeparator(operation.montantOperationAE)}" />
                                <p:separator style="border: dotted 1px #000000"/>
                                <h:outputText value="CP : #{amcCreateBacking.displayThousandSeparator(operation.montantOperationCP)}" />
                            </p:column>

                            <p:column headerText="">
                                <p:commandButton action="#{amcCreateBacking.deleteOperation('destination', operation)}" value="supprimer"
                                                 update="createForm:cibleDT" styleClass="btn-block" icon="fa fa-trash"/>
                            </p:column>
                        </p:dataTable>
                    </p:fieldset>

                    <p:fieldset legend="Equilibre des Opérations">
                        <p:panelGrid columns="3" id="equilibreDG" layout="grid">
                            <p:outputLabel value=" "/>
                            <p:outputLabel value="AE"/>
                            <p:outputLabel value="CP"/>

                            <p:outputLabel value="Cummule des retranchements" styleClass="text-bold"/>
                            <p:outputLabel value="#{amcCreateBacking.displayThousandSeparator(amcCreateBacking.cumulRetranchementAE)}"/>
                            <p:outputLabel value="#{amcCreateBacking.displayThousandSeparator(amcCreateBacking.cumulRetranchementCP)}"/>

                            <p:outputLabel value="Cummule des ajouts" styleClass="text-bold"/>
                            <p:outputLabel value="#{amcCreateBacking.displayThousandSeparator(amcCreateBacking.cumulAjoutAE)}"/>
                            <p:outputLabel value="#{amcCreateBacking.displayThousandSeparator(amcCreateBacking.cumulAjoutCP)}"/>

                            <p:outputLabel value="Equilibre des opérations"
                                           styleClass="text-bold #{amcCreateBacking.cumulRetranchementAE.subtract(amcCreateBacking.cumulAjoutAE) ne 0 ? 'text-danger' : ''}" />
                            <h:outputText value="#{amcCreateBacking.displayThousandSeparator(amcCreateBacking.cumulRetranchementAE.subtract(amcCreateBacking.cumulAjoutAE))} #{amcCreateBacking.equilibreAE()}"
                                           styleClass="text-bold #{amcCreateBacking.cumulRetranchementAE.subtract(amcCreateBacking.cumulAjoutAE) ne 0 ? 'text-danger' : ''}"/>
                            <h:outputText value="#{amcCreateBacking.displayThousandSeparator(amcCreateBacking.cumulRetranchementCP.subtract(amcCreateBacking.cumulAjoutCP))} #{amcCreateBacking.equilibreCP()}"
                                           styleClass="text-bold #{amcCreateBacking.cumulRetranchementAE.subtract(amcCreateBacking.cumulAjoutAE) ne 0 ? 'text-danger' : ''}"/>
                        </p:panelGrid>
                    </p:fieldset>

                    <p:spacer height="20" width="10"/>
                    <p:outputPanel id="enregisterBTN">
                        <div class="ui-g">
                            <div class="#{amcCreateBacking.displayEnregisterButton() ? 'ui-g-8' : 'ui-g-6'}" style="margin: 0px auto !important;">
                                <p:commandButton action="#{amcCreateBacking.persist()}" disabled="#{amcCreateBacking.displayEnregisterButton()}" icon="fa fa-save"
                                                 value="#{amcCreateBacking.displayEnregisterButton() ? 'Vous ne pourez pas enregistrer cet acte tant que l\'équilibre ne sera pas atteint.' : messages.enregistrer}" update="@form" style="width: 100%"/>
                            </div>
                        </div>
                    </p:outputPanel>
                </div>
            </div>

        </h:form>
    </h:body>
</html>
